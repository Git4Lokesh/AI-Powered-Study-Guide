<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - <%= topic %></title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
window.MathJax = {
  tex: {
    // Handle multiple delimiter formats that Perplexity might use
    inlineMath: [
      ['$', '$'], 
      ['\\(', '\\)'],
      ['//', '//']  // Handle Perplexity's inconsistent formatting
    ],
    displayMath: [
      ['$$', '$$'], 
      ['\\[', '\\]'],
      ['\\\\', '\\\\']  // Handle another inconsistent format
    ],
    // Process escaped delimiters
    processEscapes: true,
    // Handle errors gracefully
    processEnvironments: true,
    // Common mathematical macros
    macros: {
      RR: '{\\mathbb{R}}',
      ZZ: '{\\mathbb{Z}}',
      NN: '{\\mathbb{N}}',
      QQ: '{\\mathbb{Q}}',
      CC: '{\\mathbb{C}}'
    }
  },
  options: {
    // Re-render when content changes (useful for dynamic content)
    renderActions: {
      addMenu: []
    }
  },
  startup: {
    // Render when page loads
    ready: () => {
      MathJax.startup.defaultReady();
      MathJax.startup.promise.then(() => {
        console.log('MathJax initial typesetting complete');
      });
    }
  }
};
</script>
<style>
  .math-equation { 
    color: #d63384;
    font-weight: 500;
  }
  
  /* Style for display math */
  mjx-container[display="true"] {
    margin: 1em 0;
    text-align: center;
  }
  
  /* Style for inline math */
  mjx-container[display="false"] {
    display: inline-block;
    margin: 0 0.1em;
  }
</style>
</head>
<body class="bg-gradient-primary">
    <div class="container-fluid py-4">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-8">
                    
                    <!-- Header Section -->
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <a href="/" class="btn btn-outline-light btn-lg rounded-pill px-4">
                            <i class="bi bi-arrow-left me-2"></i>
                            Back to Dashboard
                        </a>
                        <div class="text-end">
                            <small class="text-white-50 d-block">Assessment</small>
                        </div>
                    </div>

                    <!-- Topic Header -->
                    <div class="text-center mb-4">
                        <div class="d-inline-flex align-items-center bg-white bg-opacity-10 rounded-pill px-4 py-2 mb-3">
                            <i class="bi bi-question-circle text-white me-2"></i>
                            <span class="text-white fw-semibold">Interactive Quiz</span>
                        </div>
                        <h1 class="display-5 fw-bold text-white mb-2"><%= topic %></h1>
                        <p class="text-white-50 mb-1">
                            <i class="bi bi-mortarboard me-2"></i>
                            Grade Level: <%= gradeLevel %>
                        </p>
                        <% if (!showResults) { %>
                            <p class="text-white-50 mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Answer all questions below and submit when complete
                            </p>
                        <% } %>
                    </div>

                    <% if (showResults) { %>
                        <!-- Quiz Results -->
                        <div class="card border-0 shadow-lg rounded-4">
                            <div class="card-body p-5 text-center">
                                <div class="mb-4">
                                    <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-10 rounded-circle p-4 mb-4">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    </div>
                                    <h2 class="text-success fw-bold mb-3">Quiz Complete!</h2>
                                    
                                    <!-- Score Display -->
                                    <div class="row justify-content-center mb-4">
                                        <div class="col-md-6">
                                            <div class="card bg-primary bg-opacity-10 border-primary border-opacity-25">
                                                <div class="card-body py-4">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="me-3">
                                                            <i class="bi bi-trophy text-primary fs-2"></i>
                                                        </div>
                                                        <div class="text-center">
                                                            <div class="fs-1 fw-bold text-primary mb-1">
                                                                <%= Math.round((score/content.length) * 100) %>%
                                                            </div>
                                                            <div class="text-muted">
                                                                <%= score %>/<%= content.length %> Correct
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Answer Review -->
                                <!-- Answer Review -->
<div class="text-start mb-4">
    <h3 class="text-primary mb-4 text-center">
        <i class="bi bi-clipboard-check me-2"></i>
        Answer Review
    </h3>
    
    <% content.forEach((item, index) => { %>
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <% if (userAnswers && userAnswers[index] === item.answer) { %>
                            <div class="bg-success bg-opacity-10 rounded-circle p-2">
                                <i class="bi bi-check text-success fs-5"></i>
                            </div>
                        <% } else { %>
                            <div class="bg-danger bg-opacity-10 rounded-circle p-2">
                                <i class="bi bi-x text-danger fs-5"></i>
                            </div>
                        <% } %>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="fw-semibold mb-2">Question <%= index + 1 %></h6>
                        <p class="mb-3 text-dark"><%= item.question %></p>
                        
                        <!-- Correct Answer - Full Width -->
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Correct Answer:</small>
                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 d-inline-block">
                                <%= item[item.answer] %>
                            </span>
                        </div>
                        
                        <!-- User Answer - Full Width, Separate Line -->
                        <% if (userAnswers && userAnswers[index]) { %>
                            <div class="mb-2">
                                <small class="text-muted d-block mb-1">Your Answer:</small>
                                <span class="badge <%= userAnswers[index] === item.answer ? 'bg-success bg-opacity-10 text-success' : 'bg-danger bg-opacity-10 text-danger' %> px-3 py-2 d-inline-block">
                                    <%= item[userAnswers[index]] || 'Not answered' %>
                                </span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    <% }) %>
</div>


                                <!-- ✨ NEW: AI Performance Analysis Section ✨ -->
                                <% if (typeof performanceAnalysis !== 'undefined' && performanceAnalysis) { %>
                                    <div class="card mt-4 border-0 shadow-lg rounded-4">
                                        <div class="card-header bg-gradient-primary text-white border-0 py-4">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
                                                    <i class="bi bi-robot text-white fs-4"></i>
                                                </div>
                                                <div>
                                                    <h4 class="text-white mb-1 fw-bold">AI Performance Analysis</h4>
                                                    <small class="text-white-75">Personalized insights powered by AI</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-5 text-start">
                                            <div class="analysis-content">
                                                <%- performanceAnalysis %>
                                            </div>
                                            
                                            <!-- Analysis Footer -->
                                            <div class="mt-4 pt-4 border-top">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <small class="text-muted">
                                                        <i class="bi bi-lightbulb-fill me-1"></i>
                                                        Generated by AI to help improve your learning
                                                    </small>
                                                    <div class="d-flex gap-2">
                                                        <button class="btn btn-outline-primary btn-sm" onclick="copyAnalysis()">
                                                            <i class="bi bi-clipboard me-1"></i>
                                                            Copy Analysis
                                                        </button>
                                                        <button class="btn btn-outline-success btn-sm" onclick="window.print()">
                                                            <i class="bi bi-printer me-1"></i>
                                                            Print
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                                
                                <!-- Action Buttons -->
                                <div class="row mt-5">
                                    <div class="col-md-6 mb-3">
                                        <a href="/" class="btn btn-primary btn-lg w-100 py-3">
                                            <i class="bi bi-house me-2"></i>
                                            Back to Dashboard
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <a href="/?topic=<%= encodeURIComponent(topic) %>&gradeLevel=<%= gradeLevel %>&studyType=quiz" class="btn btn-outline-primary btn-lg w-100 py-3">
                                            <i class="bi bi-arrow-clockwise me-2"></i>
                                            Retake Quiz
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% } else { %>
                        <!-- Quiz Questions Form -->
                        <form action="/quiz" method="POST">
                            <input type="hidden" name="topic" value="<%= topic %>">
                            <input type="hidden" name="gradeLevel" value="<%= gradeLevel %>">
                            
                            <!-- Question Count Info -->
                            <div class="text-center mb-4">
                                <span class="badge bg-white bg-opacity-10 text-white px-4 py-2 fs-6">
                                    <i class="bi bi-list-check me-2"></i>
                                    <%= content.length %> Questions
                                </span>
                            </div>
                            
                            <!-- All Questions -->
                            <% content.forEach((item, index) => { %>
                                <div class="card border-0 shadow-lg rounded-4 mb-4">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                                <span class="text-primary fw-bold"><%= index + 1 %></span>
                                            </div>
                                            <h6 class="text-primary fw-semibold mb-0">Question <%= index + 1 %></h6>
                                        </div>
                                        
                                        <div class="question-text mb-4">
                                            <h5 class="text-dark lh-base"><%= item.question %></h5>
                                        </div>
                                        
                                        <div class="row g-2">
                                            <div class="col-12">
                                                <input type="radio" 
                                                       class="btn-check" 
                                                       id="q<%= index %>_option1" 
                                                       name="answer_<%= index %>" 
                                                       value="option1" 
                                                       required>
                                                <label class="btn btn-outline-primary w-100 text-start p-3" 
                                                       for="q<%= index %>_option1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary bg-opacity-10 text-primary me-3 px-2 py-1">A</span>
                                                        <%= item.option1 %>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="col-12">
                                                <input type="radio" 
                                                       class="btn-check" 
                                                       id="q<%= index %>_option2" 
                                                       name="answer_<%= index %>" 
                                                       value="option2" 
                                                       required>
                                                <label class="btn btn-outline-primary w-100 text-start p-3" 
                                                       for="q<%= index %>_option2">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary bg-opacity-10 text-primary me-3 px-2 py-1">B</span>
                                                        <%= item.option2 %>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="col-12">
                                                <input type="radio" 
                                                       class="btn-check" 
                                                       id="q<%= index %>_option3" 
                                                       name="answer_<%= index %>" 
                                                       value="option3" 
                                                       required>
                                                <label class="btn btn-outline-primary w-100 text-start p-3" 
                                                       for="q<%= index %>_option3">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary bg-opacity-10 text-primary me-3 px-2 py-1">C</span>
                                                        <%= item.option3 %>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="col-12">
                                                <input type="radio" 
                                                       class="btn-check" 
                                                       id="q<%= index %>_option4" 
                                                       name="answer_<%= index %>" 
                                                       value="option4" 
                                                       required>
                                                <label class="btn btn-outline-primary w-100 text-start p-3" 
                                                       for="q<%= index %>_option4">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary bg-opacity-10 text-primary me-3 px-2 py-1">D</span>
                                                        <%= item.option4 %>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                            
                            <!-- Submit Button -->
                            <div class="text-center mt-4 mb-5">
                                <button type="submit" class="btn btn-primary btn-lg px-5 py-3">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Submit Quiz
                                    <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    <% } %>

                    <!-- Study Tips -->
                    <div class="text-center mt-4">
                        <small class="text-white-50">
                            <i class="bi bi-lightbulb me-1"></i>
                            <% if (showResults) { %>
                                Review your answers to identify areas for improvement
                            <% } else { %>
                                Take your time and read each question carefully
                            <% } %>
                        </small>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript for Analysis Features -->
    <script>
        function copyAnalysis() {
            const analysisContent = document.querySelector('.analysis-content').innerText;
            navigator.clipboard.writeText(analysisContent).then(() => {
                // Show success feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check me-1"></i> Copied!';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
    </script>
    
    <!-- Custom CSS for enhanced styling -->
    <style>
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15) !important;
        }
        
        .btn-check:checked + .btn {
            background-color: var(--bs-primary) !important;
            color: white !important;
            border-color: var(--bs-primary) !important;
        }
        
        .btn-check:checked + .btn .badge {
            background-color: white !important;
            color: var(--bs-primary) !important;
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        /* AI Analysis Specific Styles */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        .analysis-content {
            font-size: 1.05rem;
            line-height: 1.7;
        }
        
        .analysis-content h1,
        .analysis-content h2,
        .analysis-content h3,
        .analysis-content h4,
        .analysis-content h5,
        .analysis-content h6 {
            color: #667eea;
            margin: 1.5rem 0 1rem 0;
            font-weight: 600;
        }
        
        .analysis-content ul,
        .analysis-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .analysis-content li {
            margin-bottom: 0.5rem;
        }
        
        .analysis-content strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .text-white-75 {
            color: rgba(255, 255, 255, 0.75) !important;
        }
        
        @media (max-width: 768px) {
            .card-body {
                padding: 2rem !important;
            }
            
            .btn {
                font-size: 0.9rem;
            }
            
            .analysis-content {
                font-size: 1rem;
            }
        }
        
        /* Print styles for analysis */
        @media print {
            .card-header {
                background: #f8f9fa !important;
                color: #333 !important;
            }
            
            .bg-gradient-primary {
                background: #f8f9fa !important;
            }
            
            .analysis-content h1,
            .analysis-content h2,
            .analysis-content h3,
            .analysis-content h4,
            .analysis-content h5,
            .analysis-content h6 {
                color: #333 !important;
            }
        }
    </style>
</body>
</html>
